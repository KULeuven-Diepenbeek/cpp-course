<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.81.0" />
    <meta name="description" content="">


    <link rel="icon" href="../../images/favicon.png" type="image/png">

    <title>8. Abstractielagen :: Software Ontwerp in C(&#43;&#43;)</title>

    
    <link href="../../css/nucleus.css?1637147183" rel="stylesheet">
    <link href="../../css/fontawesome-all.min.css?1637147183" rel="stylesheet">
    <link href="../../css/featherlight.min.css?1637147183" rel="stylesheet">
    <link href="../../css/perfect-scrollbar.min.css?1637147183" rel="stylesheet">
    <link href="../../css/auto-complete.css?1637147183" rel="stylesheet">
    <link href="../../css/theme.css?1637147183" rel="stylesheet">
    <link href="../../css/hugo-theme.css?1637147183" rel="stylesheet">
    
    <link href="../../css/theme-kul.css?1637147183" rel="stylesheet">
    
    

    <script src="../../js/jquery-3.3.1.min.js?1637147183"></script>

    <style>
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="../../gba-in-cpp/abstractions/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="https://www.kuleuven.be/kuleuven/" target="_blank">
	<img src="../../img/style/kul.png" alt="KU Leuven" /><br/>
</a>
<a href="https://www.uhasselt.be/" target="_blank">
	<img src="../../img/style/uhasselt.svg" alt="UHasselt" id="uhlogo" />
</a>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="../../js/lunr.min.js?1637147183"></script>
<script type="text/javascript" src="../../js/auto-complete.js?1637147183"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/kuleuven-diepenbeek.github.io\/cpp-course\/";
    
</script>
<script type="text/javascript" src="../../js/search.js?1637147183"></script>

    
  </div>

    <div class="highlightable">
    <h3><a href="../../">Inhoudsopgave</a></h3>
    <ul class="topics">
        
          
          




 
  
    
    <li data-nav-id="/hoorcolleges/" title="Hoorcolleges" class="dd-item 
        
        
        
        ">
      <a href="../../hoorcolleges/">
          Hoorcolleges
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/hoorcolleges/slides-1/" title="1. Introductie in C/C&#43;&#43;: context, ecosysteem" class="dd-item ">
        <a href="../../hoorcolleges/slides-1/">
        1. Introductie in C/C&#43;&#43;: context, ecosysteem
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/hoorcolleges/slides-2/" title="2. Pointers in C, dynamisch geheugen in C&#43;&#43;" class="dd-item ">
        <a href="../../hoorcolleges/slides-2/">
        2. Pointers in C, dynamisch geheugen in C&#43;&#43;
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/hoorcolleges/slides-3/" title="3. Introductie in Object-Georiënteerd denken in C&#43;&#43;" class="dd-item ">
        <a href="../../hoorcolleges/slides-3/">
        3. Introductie in Object-Georiënteerd denken in C&#43;&#43;
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/hoorcolleges/slides-4/" title="4. Een introductie in GUI ontwerp met Qt, Samenvatting, examen info" class="dd-item ">
        <a href="../../hoorcolleges/slides-4/">
        4. Een introductie in GUI ontwerp met Qt, Samenvatting, examen info
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/c/" title="A. Introductie in C" class="dd-item 
        
        
        
        ">
      <a href="../../c/">
          A. Introductie in C
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/c/preparation/" title="0. Voorbereiding Thuis" class="dd-item ">
        <a href="../../c/preparation/">
        0. Voorbereiding Thuis
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/c/intro/" title="1. Introductie in C" class="dd-item ">
        <a href="../../c/intro/">
        1. Introductie in C
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/c/pointers/" title="2. Pointers in C en C&#43;&#43;" class="dd-item ">
        <a href="../../c/pointers/">
        2. Pointers in C en C&#43;&#43;
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/c/stack-vs-heap/" title="2.1. De stack VS de heap" class="dd-item ">
        <a href="../../c/stack-vs-heap/">
        2.1. De stack VS de heap
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/gba-in-c/" title="B. GBA programming in C" class="dd-item 
        
        
        
        ">
      <a href="../../gba-in-c/">
          B. GBA programming in C
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/gba-in-c/preparation/" title="0. Voorbereiding Thuis" class="dd-item ">
        <a href="../../gba-in-c/preparation/">
        0. Voorbereiding Thuis
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/gba-in-c/gba-intro/" title="3. Introductie in GBA Programming" class="dd-item ">
        <a href="../../gba-in-c/gba-intro/">
        3. Introductie in GBA Programming
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/gba-in-c/tilesets/" title="4. GBA Tilesets, een simpel spel" class="dd-item ">
        <a href="../../gba-in-c/tilesets/">
        4. GBA Tilesets, een simpel spel
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/cpp/" title="C. Introductie in C&#43;&#43;" class="dd-item 
        
        
        
        ">
      <a href="../../cpp/">
          C. Introductie in C&#43;&#43;
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/cpp/preparation/" title="0. Voorbereiding Thuis" class="dd-item ">
        <a href="../../cpp/preparation/">
        0. Voorbereiding Thuis
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/cpp/cpp-intro/" title="5. Van C naar C&#43;&#43;" class="dd-item ">
        <a href="../../cpp/cpp-intro/">
        5. Van C naar C&#43;&#43;
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/cpp/inheritance/" title="6. Inheritance, templates, ops" class="dd-item ">
        <a href="../../cpp/inheritance/">
        6. Inheritance, templates, ops
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/cpp/software-design/" title="7. Software ontwerp en design" class="dd-item ">
        <a href="../../cpp/software-design/">
        7. Software ontwerp en design
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/gba-in-cpp/" title="D. GBA Programming in C&#43;&#43;" class="dd-item 
        parent
        
        
        ">
      <a href="../../gba-in-cpp/">
          D. GBA Programming in C&#43;&#43;
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/gba-in-cpp/preparation/" title="0. Voorbereiding Thuis" class="dd-item ">
        <a href="../../gba-in-cpp/preparation/">
        0. Voorbereiding Thuis
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/gba-in-cpp/abstractions/" title="8. Abstractielagen" class="dd-item active">
        <a href="../../gba-in-cpp/abstractions/">
        8. Abstractielagen
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/gba-in-cpp/scrolling-backgrounds/" title="9. Scrolling backgrounds" class="dd-item ">
        <a href="../../gba-in-cpp/scrolling-backgrounds/">
        9. Scrolling backgrounds
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/gba-in-cpp/qt/" title="10. GUI ontwerp met C&#43;&#43; in Qt" class="dd-item ">
        <a href="../../gba-in-cpp/qt/">
        10. GUI ontwerp met C&#43;&#43; in Qt
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/gba-in-cpp/gba-to-qt/" title="11. Een GBA spel porten naar Qt" class="dd-item ">
        <a href="../../gba-in-cpp/gba-to-qt/">
        11. Een GBA spel porten naar Qt
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          




 
  
    
    <li data-nav-id="/extra/" title="E. Extras" class="dd-item 
        
        
        
        ">
      <a href="../../extra/">
          E. Extras
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            




 
  
    
      <li data-nav-id="/extra/project/" title="Project opdracht" class="dd-item ">
        <a href="../../extra/project/">
        Project opdracht
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/extra/cheatsheet/" title="C Cheat Sheet" class="dd-item ">
        <a href="../../extra/cheatsheet/">
        C Cheat Sheet
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/extra/buildsystems/" title="Een introductie in C(&#43;&#43;) Build Systemen" class="dd-item ">
        <a href="../../extra/buildsystems/">
        Een introductie in C(&#43;&#43;) Build Systemen
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/extra/faq/" title="FAQ" class="dd-item ">
        <a href="../../extra/faq/">
        FAQ
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/extra/installaties/" title="Installatieinstructies" class="dd-item ">
        <a href="../../extra/installaties/">
        Installatieinstructies
        
        </a>
    </li>
     
  
 

            
          
            
            




 
  
    
      <li data-nav-id="/extra/poll/" title="Poll: Ben ik klaar voor mijn examen?" class="dd-item ">
        <a href="../../extra/poll/">
        Poll: Ben ik klaar voor mijn examen?
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li> 
                  <a class="padding" href="https://www.uhasselt.be/studiegids"><i class='fa fa-university'></i> ECTS Sheet</a>
              </li>
          
              <li> 
                  <a class="padding" href="https://toledo.kuleuven.be/portal/"><i class='fa fa-university'></i> Toledo</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="https://getgrav.org">Grav</a> and <a href="https://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>




        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            <a href='../../'>Software ontwerp in C/C++</a> > <a href='../../gba-in-cpp/'>D. GBA Programming in C++</a> > 8. Abstractielagen
          
        
          
        
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
  <ul>
    <li><a href="#abstracties-creëren">Abstracties creëren</a></li>
    <li><a href="#de-gameboy-advance-en-c">De Gameboy Advance en C++</a>
      <ul>
        <li><a href="#een-minimale-2d-sprite-engine">Een minimale 2D sprite engine</a></li>
      </ul>
    </li>
    <li><a href="#image-data-importeren">Image data importeren</a>
      <ul>
        <li><a href="#een-kijkje-achter-de-schermen">Een kijkje achter de schermen</a></li>
      </ul>
    </li>
    <li><a href="#a-nameoefalabo-oefeningen"><a name="oef"></a>Labo oefeningen</a></li>
    <li><a href="#denkvragen">Denkvragen</a></li>
  </ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              8. Abstractielagen
            </h1>
          

        


<p>Het zal je ondertussen wel al duidelijk zijn dat technische details zoals IO pointers en OAM vanuit <a href="../../gba-in-c/labo-4">labo 4</a> de code er niet bepaald duidelijker op maken. Jammer genoeg voorziet de GBA geen andere mogelijkheden. Een oplossing zal van de ontwikkelaar zelf moeten komen, in de vorm van de principes uit <a href="../../cpp/labo-7">labo 7</a>.</p>
<h2 id="abstracties-creëren">Abstracties creëren</h2>
<p>Als ontwikkelaar wil ik niet altijd bezig zijn met de juiste hexadecimale waarde voor IO pointer aan te spreken om een sprite te renderen. Dit zou éénmalig voorzien moeten worden, en dan <strong>herbruikbaar</strong> moeten zijn. Herbruikbaarheid betekent:</p>
<ol>
<li>In C: gebruik maken van <code>function</code>, <code>struct</code></li>
<li>In C++: gebruik maken van <code>class</code> bovenop bovenstaande.</li>
</ol>
<p><a href="../../teaching/cpp/labo-4-gba-2.c">De oplossing van labo 4</a> voorziet methodes als <code>create_sprite</code> die zowel voor de bal, de paddle als de blokken aangeroepen kunnen worden. Omdat de OAM structuur té low-level is, voorzien we een abstractielaag: de functie geeft een <code>sprite*</code> struct terug die we zelf ontworpen hebben:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#00a8c8">typedef</span> <span style="color:#00a8c8">struct</span> <span style="color:#111">sprite</span> <span style="color:#111">{</span>
    <span style="color:#00a8c8">int</span> <span style="color:#111">x</span><span style="color:#111">;</span>  <span style="color:#75715e">// position
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">int</span> <span style="color:#111">y</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">int</span> <span style="color:#111">dx</span><span style="color:#111">;</span> <span style="color:#75715e">// velocity
</span><span style="color:#75715e"></span>    <span style="color:#00a8c8">int</span> <span style="color:#111">dy</span><span style="color:#111">;</span>
    <span style="color:#111">uint8</span> <span style="color:#111">w</span><span style="color:#111">;</span>  <span style="color:#75715e">// dimensions (bvb simple hitbox detection)
</span><span style="color:#75715e"></span>    <span style="color:#111">uint8</span> <span style="color:#111">h</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">volatile</span> <span style="color:#111">oam_object</span> <span style="color:#f92672">*</span><span style="color:#111">obj</span><span style="color:#111">;</span>
<span style="color:#111">}</span> <span style="color:#111">sprite</span><span style="color:#111">;</span>
</code></pre></div><p>De sprite struct heeft een reference naar <code>oam_object*</code> vast. Dit noemt men &ldquo;<strong>wrapping</strong>&quot;: de code kan niet rechstreeks aan het object maar moet met de sprite werken. In C zijn er geen mogelijkheden om dit te encapsuleren met een access modifier zoals C++' <code>private</code>.</p>
<p>Vergeet niet dat deze eigenschappen redundant zijn en geheugen innemen voor niets&hellip; In de OAM struct zitten eigenlijk in bepaalde bits diezelfde eigenschappen (x, y, w, h). De afweging tussen gebruiksgemak en geheugengebruik is in dit geval echter eenvoudig gemaakt. <code>sprite.x</code> is een pak eenvoudiger in gebruik dan <code>sprite.obj-&gt;attr1 | OAM_X_MASK</code>!</p>
<script defer src="../../mermaid/mermaid.min.js">
	mermaid.initialize({
		startOnLoad: true,
		flowchart: {
			useMaxWidth: true
		}
	});
</script>
<div class="mermaid" align="center" >
	
graph TD;
  A[highlevel Sprite struct]
  B[lowlevel OAM struct]
  A --> |obj*|B

</div>
<p>De waardes in de sprite manipuleren levert echter een synchronisatie probleem op: de GBA reageert enkel op het OAM geheugen dus we moeten beide waardes <em>in sync</em> houden:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#00a8c8">void</span> <span style="color:#75af00">position</span><span style="color:#111">(</span><span style="color:#111">sprite</span> <span style="color:#f92672">*</span><span style="color:#111">s</span><span style="color:#111">)</span> <span style="color:#111">{</span>
    <span style="color:#00a8c8">volatile</span> <span style="color:#111">object</span> <span style="color:#f92672">*</span><span style="color:#111">obj</span> <span style="color:#f92672">=</span> <span style="color:#111">s</span><span style="color:#f92672">-&gt;</span><span style="color:#111">obj</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">int</span> <span style="color:#111">x</span> <span style="color:#f92672">=</span> <span style="color:#111">s</span><span style="color:#f92672">-&gt;</span><span style="color:#111">x</span><span style="color:#111">;</span>
    <span style="color:#00a8c8">int</span> <span style="color:#111">y</span> <span style="color:#f92672">=</span> <span style="color:#111">s</span><span style="color:#f92672">-&gt;</span><span style="color:#111">y</span><span style="color:#111">;</span>
    <span style="color:#111">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#111">attr0</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#111">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#111">attr0</span> <span style="color:#f92672">&amp;</span>  <span style="color:#f92672">~</span><span style="color:#111">OAM_Y_MASK</span><span style="color:#111">)</span> <span style="color:#f92672">|</span> <span style="color:#111">(</span><span style="color:#111">y</span> <span style="color:#f92672">&amp;</span> <span style="color:#111">OAM_Y_MASK</span><span style="color:#111">);</span>
    <span style="color:#111">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#111">attr1</span> <span style="color:#f92672">=</span> <span style="color:#111">(</span><span style="color:#111">obj</span><span style="color:#f92672">-&gt;</span><span style="color:#111">attr1</span> <span style="color:#f92672">&amp;</span> <span style="color:#f92672">~</span><span style="color:#111">OAM_X_MASK</span><span style="color:#111">)</span> <span style="color:#f92672">|</span> <span style="color:#111">(</span><span style="color:#111">x</span> <span style="color:#f92672">&amp;</span> <span style="color:#111">OAM_X_MASK</span><span style="color:#111">);</span>
<span style="color:#111">}</span>
</code></pre></div><h2 id="de-gameboy-advance-en-c">De Gameboy Advance en C++</h2>
<p>De devKit toolchain voorziet ook een C++ cross-compiler: <code>arm-none-eabi-gcc</code> wordt simpelweg <code>arm-none-eabi-g++</code>. <em>That&rsquo;s it!</em> Je kan C++11 gebruiken en naar hartelust STL bibliotheken in de code verwerken in plaats van met <code>char*</code> &ldquo;collecties&rdquo; te moeten werken.</p>
<p>Echter&hellip; Er is geen enkel productiespel ooit uitgebracht op een cartridge dat in C++ geschreven is. Dit om de eenvoudige reden dat C++ een hoop overhead met zich meebrengt:</p>
<ul>
<li>De <em>footprint</em> van een <code>.gba</code> ROM is véél groter in C++ door extra libraries</li>
<li>De memory <em>footprint</em> van een <code>class</code> t.o.v. een <code>struct</code> zou +/- 4 bytes extra zijn</li>
</ul>
<p>Gezien de erg beperkte hardwaremogelijkheden van de GBA is het voor veel grote spellen praktisch gezien niet haalbaar om alles in C++ te schrijven. Trouwens ook niet in C: veel kritieke instructies in engines zijn nog in Assembly geschreven.</p>
<p><code>ls -la</code> output:</p>
<pre>
-rwxr-xr-x   1 wgroenev  staff    8320 Jul 25 13:54 main_c.gba
-rwxr-xr-x   1 wgroenev  staff   23328 Jul 22 20:36 main_cpp.gba
-rwxr-xr-x   1 wgroenev  staff   24032 Jul 25 13:55 main_cpp_stl.gba
</pre>
<p>De C++ ROM is 280% groter dan de C ROM, als je <code>&lt;vector&gt;</code> e.d. mee include zelfs 288% - van 8K naar 23K!</p>
<p>Voor Software ontwerp in C/C++ ligt de focus op <strong>software ontwerp</strong>, niet op performante algoritmes of hardware. Wij gaan dit &ldquo;probleem&rdquo; dus straal negeren en vanaf nu alles in C++ schrijven. Emulators hebben hier geen probleem mee, evenals de EZ-FLASH Omega ROM die ik gebruik om op echte hardware te draaien.</p>
<h3 id="een-minimale-2d-sprite-engine">Een minimale 2D sprite engine</h3>
<p>Welke concepten hebben we nodig om een minimaal spel te ontwerpen dat met 2D sprites werkt (<code>MODE1</code>)? Neem de Arkanoid clone opnieuw als voorbeeld. Ook technische vereisten zoals deze kunnen in een analyse gegoten worden om de ontwerpfase van het ontwikkelen te vergemakkelijken:</p>
<pre>
GBA001. Een minimale 2D sprite engine

Beschrijving:
Als programmeur wil ik niet bezig zijn met technische details van de GBA interface bij het ontwikkelen van een spel.
Ik wil eenvoudig sprites op het beeld kunnen toveren en deze kunnen manipuleren.

Context: Het moet mogelijk zijn om het gebruik van OAM en VRAM te vergemakkelijken.

Acceptatiecriteria:
- Ik wil als ontwikkelaar bij het boostrappen van het spel "sprite mode" kunnen kiezen.
- Ik wil makkelijk sprites kunnen toevoegen aan de hand van een externe image in jpg/png formaat zonder iets van het palet af te weten.
- Ik wil sprites kunnen verplaatsen op het scherm
- Ik wil eenvoudig kunnen zien of sprite 1 "botst" met sprite 2.
</pre>
<p>Dit vraagt niet om een volledige herwerking van de opgave uit labo 4, maar om een abstractielaag in de vorm van klassen. Welke concepten kunnen we afleiden uit de analyse, of welke ontbreken er nog?</p>
<script defer src="../../mermaid/mermaid.min.js">
	mermaid.initialize({
		startOnLoad: true,
		flowchart: {
			useMaxWidth: true
		}
	});
</script>
<div class="mermaid" align="center" >
	
graph TD;
  Z{GBA}
  A{SpriteManager}
  B{Sprite}
  C[OAM]
  D[Palet]
  E[ImageData]
  Z --> |setRenderer|A
  A --> |add<br/>1 op veel|B
  B --> |"collidesWith(other)"|B
  B --> |"move(x,y)"|B
  B -.-> C
  B -.-> D
  B -.-> E

</div>
<p>Bovenstaand model kan afwijken van wat jij in gedachten had: hier is geen enkelvoudig antwoord op te geven, de enige vereiste is een laag tussen het gebruik van OAM, VRAM en de programmeur die als designer optreedt.</p>
<p>Denk bij het ontwerpen van een klasse na over eventuele logische operatoren die van pas kunnen komen. Het is niet de bedoeling om een hoop overrides te implementeren om te laten zien hoe goed je daar in bent: code wordt &ldquo;<em>just-in-time</em>&rdquo; geschreven: <a href="https://en.wikipedia.org/wiki/You_aren%27t_gonna_need_it">YAGNI</a>. Templates en abstracte klassen zijn ook niet altijd nodig.</p>
<p>Ga uit van het eenvoudigst mogelijke. Welke minimale elementen heb je absoluut nodig om de vereiste analyse tot een goed einde te brengen? Laat alle toeters en bellen achterwege en concentreer je op herbruikbaarheid en Clean Code.</p>
<h2 id="image-data-importeren">Image data importeren</h2>
<p>Het OAM is gekoppeld aan een referentie naar het palet samen met een referentie naar het VRAM waar je je image data in de vorm van een &ldquo;tileset&rdquo; hebt opgeslagen. Voor de paddle voorzagen wij met een simpele for lus onze eigen tile data:</p>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">    <span style="color:#00a8c8">for</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#111">;</span> <span style="color:#111">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">sizeof</span><span style="color:#111">(</span><span style="color:#111">tile_4bpp</span><span style="color:#111">)</span> <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span><span style="color:#111">;</span> <span style="color:#111">i</span><span style="color:#f92672">++</span><span style="color:#111">)</span> <span style="color:#111">{</span>
        <span style="color:#111">paddle_tile</span><span style="color:#111">[</span><span style="color:#111">i</span><span style="color:#111">]</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x2222</span><span style="color:#111">;</span>
    <span style="color:#111">}</span>
</code></pre></div><p>In de praktijk wordt art aangeleverd door 2D artiesten die gespecialiseerd zijn in pixel art. Deze files moeten we vertalen naar hexadecimale waarden gegroepeerd in tileset en palet data.</p>
<p>Gegeven de volgende &ldquo;pixel art&rdquo;:</p>
<p><img src="../../img/teaching/cpp/labo-8-kul.png" /></p>
<p>Herinner je dat OAM data vaste groottes hebben: we kiezen hier voor 64x32. Hoe verwerken we deze png in de ROM? Emulator screenshot:</p>
<p><img src="../../img/teaching/cpp/labo-8-kul-0.png" /></p>
<p>Daar hebben we <a href="https://github.com/IanFinlayson/png2gba">png2gba</a> voor nodig, die de image omzet naar hexadecimale data. De <a href="../../teaching/cpp/labo-8-kulsprite.c">broncode van bovenstaande screenshot</a> verduidelijkt dit. Op de github pagina staan instructies om het tooltje te compileren.</p>
<ol>
<li>Exporteer een header file: <code>png2gba -p -t img.png</code></li>
<li><code>#include &lt;kul.h&gt;</code></li>
<li>Kopiëer data rechtstreeks naar VRAM met <code>memcpy</code></li>
<li>Map palet en VRAM index op een OAM object zoals gezien in labo 4</li>
</ol>
<div class="highlight"><pre style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C"><span style="color:#00a8c8">void</span> <span style="color:#75af00">copy_image_data</span><span style="color:#111">()</span> <span style="color:#111">{</span>
    <span style="color:#111">memcpy</span><span style="color:#111">(</span><span style="color:#111">pal_fg_mem</span><span style="color:#111">,</span> <span style="color:#111">kul_palette</span><span style="color:#111">,</span> <span style="color:#00a8c8">sizeof</span><span style="color:#111">(</span><span style="color:#111">kul_palette</span><span style="color:#111">));</span>
    <span style="color:#111">memcpy</span><span style="color:#111">(</span><span style="color:#f92672">&amp;</span><span style="color:#111">tile_mem</span><span style="color:#111">[</span><span style="color:#ae81ff">0</span><span style="color:#111">][</span><span style="color:#ae81ff">0</span><span style="color:#111">],</span> <span style="color:#111">kul_data</span><span style="color:#111">,</span> <span style="color:#00a8c8">sizeof</span><span style="color:#111">(</span><span style="color:#111">kul_data</span><span style="color:#111">));</span>
<span style="color:#111">}</span>
</code></pre></div><p>OAM attributes maken het eenvoudig om de image horizontaal of verticaal te <em>flippen</em>, bijvoorbeeld bij sprite animaties die naar links of naar rechts lopen. Transformatiematriches zijn nodig om te roteren.</p>
<p>Export tool <a href="http://www.coranac.com/projects/#grit">Grit</a> (Voor Windows gebruikers: <a href="https://www.coranac.com/man/grit/html/wingrit.htm">Wingrit</a>) geeft meer mogelijkheden, om bijvoorbeeld stukken van een palet te exporteren met <code>./grit piskel.png -p -gt -gB4 -ftc -pe 16</code> - zie <a href="http://www.coranac.com/man/grit/html/grit.htm">handleiding</a>. Maak op <a href="www.piskelapp.com">piskelapp.com</a> je eigen pixel art.</p>
<h3 id="een-kijkje-achter-de-schermen">Een kijkje achter de schermen</h3>
<p>Emulators zoals mGBA zijn krachtige tools voor de beginnende GBA ontwikkelaar om te graven in hun favoriete ROM. Ze bieden de mogelijkheid om tiles, palettes, sprites, geheugenwaardes, &hellip; allemaal in te kijken. Een van mijn favoriete games is Castlevania: Aria of Sorrow. Ik kan met mGBA zien hoe de sprites zijn opgedeeld in het scherm.</p>
<p>Probeer aan de hand van deze animatie maar eens te bepalen welke sprites gebrukt worden, en welke achtergronden:</p>
<p><img src="../../img/teaching/cpp/aria-of-sorrow.gif" style="width: 100%" class="bordered" /></p>
<p>Herinner je uit labo 4 dat er 4 VRAM pointers naar achtergrond geheugen is: 4 char blocks. Bovenstaand spel creëert zo de illusie van diepte: verschillende achtergronden schuiven over elkaar met verschillende snelheden (kijk goed naar de maan).</p>
<div class="row">
  <div class="col-md-6">
      <img src="../../img/teaching/cpp/aria-of-sorrow-0.png" /><br/>
      Alles aan
  </div>
  <div class="col-md-6">
    <img src="../../img/teaching/cpp/aria-of-sorrow-1.png" /><br/>
    Sprites (OAM) uit
  </div>
</div>
<div class="row">
  <div class="col-md-6">
    <img src="../../img/teaching/cpp/aria-of-sorrow-2.png" /><br/>
    bg3 uit
  </div>
  <div class="col-md-6">
    <img src="../../img/teaching/cpp/aria-of-sorrow-3.png" /><br/>
    bg2 uit
  </div>
</div>
<p>Uiteindelijk stelt zo&rsquo;n 2D platformspel niet zo veel voor op gebied van sprite engine. Er kunnen immers maar maximum 128 objecten tegelijkertijd in het geheugen opgeslagen worden. In Aria of Sorrow wordt dat opgelost met &ldquo;tussenschermen&rdquo;: van area 1 naar 2 moet je door een soort van sluis. In de achtergrond wordt een hoop nieuwe data in alle IO adressen gepompt.</p>
<p>Het meeste werk ligt bij de artist. De screenshot linksboven toont de aanwezigheid van 2 personage sprites (Alucard en Soma) en 3 nummer sprites (Healthbar: 3, 2, 0). Toch klopt dit niet helemaal als je graaft in de mGBA sprite explorer:</p>
<p><img src="../../img/teaching/cpp/aria-of-sorrow-sprites.png" /></p>
<p>Soma bestaat uit 2x 64x32 OAM objecten! <br/>
Er zal dus ook een soort van OAM manager nodig zijn die beide sprites aan elkaar rijgt, zodat in de code en in het spel dit één sprite lijkt te zijn. Dit zijn nog <a href="http://gbdev.gg8.se/wiki/articles/GBDK_Sprite_Tutorial">artefacten van de originele Gameboy</a>.</p>
<h2 id="a-nameoefalabo-oefeningen"><a name="oef"></a>Labo oefeningen</h2>
<ol>
<li>Implementeer bovenstaande technische analyse in C++. Verterk vanuit een <a href="../../teaching/cpp/labo-4-gba-2.c">modeloplossing</a> van labo 4. Bedenk welke verplichte parameters nodig zijn om een sprite &ldquo;in te laden&rdquo;. Test om te beginnen de C implementatie met de <code>gcc</code> compiler met behulp van de Makefile uit <a href="../../teaching/cpp/labo-3-gba.Makefile">labo 3</a>.</li>
<li>Voorzie ook een <code>KeyManager</code> die inlezen van toetsen abstraheert. Werken met functie pointers als callback methodes is niet nodig.</li>
</ol>
<p>Voor oefening 1 is er een alternatief met CLion en CMake: Verterk vanuit deze template: <a href="../../teaching/cpp/labo8-gbagplusplus.zip">labo8-gbagplusplus.zip</a>.</p>
<p>In CLion kan je rechtstreeks de emulator uitvoeren door de <code>.gba</code> file als argument mee te geven. Dat doe je via menu &ldquo;Run as&hellip;&rdquo; (met drie puntjes) onder &ldquo;Run&rdquo;:</p>
<p><img src="../../img/runmgba.png" alt=""></p>
<p>Als je <strong>Edit Run Configurations</strong> selecteert, verschijnt het volgende venster:</p>
<p><img src="../../img/runmenu.png" alt=""></p>
<p>Daar stel je de volgende waardes in:</p>
<ol>
<li>Executable: <code>mgba</code> (of <code>.exe</code> voor Windows machines), volledig pad naar de binary</li>
<li>Working Directory: de juiste <code>cmake-build-debug/...</code> subfolder waar de <code>.gba</code> file staat</li>
<li>Target: het uit te voeren project, onder <code>.elf</code></li>
<li>Program Arguments: bestandsnaam van de <code>.gba</code> file</li>
</ol>
<p>Hier kan je ook <strong>nieuwe configs</strong> toevoegen met het <code>+</code> symbool linksboven.</p>
<h2 id="denkvragen">Denkvragen</h2>
<ol>
<li>Welke functies uit de opgave zou je <em>niet</em> abstraheren in klassen maar voldoen aan een duidelijke naamgeving? Waarom zouden dezen wel in de global namespace mogen leven?</li>
<li>Wat als ik een sprite nodig heb die groter is dan 64x64? Wat zou de <code>SpriteManager</code> klasse moeten teruggeven bij het aanmaken van een &ldquo;sprite&rdquo; (niet een GBA sprite, maar de term die wij handhaven)?</li>
</ol>


<footer class="footline">
	
</footer>

        
        </div>
        

      </div>

    <div id="navigation">
        
        

        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        

        


	 
	 
		
			<a class="nav nav-prev" href="../../gba-in-cpp/preparation/" title="0. Voorbereiding Thuis"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="../../gba-in-cpp/scrolling-backgrounds/" title="9. Scrolling backgrounds" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>

    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="../../js/clipboard.min.js?1637147183"></script>
    <script src="../../js/perfect-scrollbar.min.js?1637147183"></script>
    <script src="../../js/perfect-scrollbar.jquery.min.js?1637147183"></script>
    <script src="../../js/jquery.sticky.js?1637147183"></script>
    <script src="../../js/featherlight.min.js?1637147183"></script>
    <script src="../../js/modernizr.custom-3.6.0.js?1637147183"></script>
    <script src="../../js/learn.js?1637147183"></script>
    <script src="../../js/hugo-learn.js?1637147183"></script>
    
        
            <script src="../../mermaid/mermaid.js?1637147183"></script>
        
        <script>
            mermaid.initialize({ startOnLoad: true });
        </script>
    
    

  </body>
</html>

